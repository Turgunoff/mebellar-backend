# Mebellar Backend API

## ğŸ“‹ Loyiha Tavsifi

**Mebellar Olami Backend** - Premium mebel marketplace platformasi uchun RESTful API serveri. Go dasturlash tilida yozilgan, PostgreSQL ma'lumotlar bazasi bilan ishlaydi. Platforma mijozlar (customer) va sotuvchilar (seller) uchun to'liq funksionallikni ta'minlaydi.

### Asosiy Vazifalar:

- ğŸ” Foydalanuvchi autentifikatsiyasi va autorizatsiyasi (JWT)
- ğŸ“± SMS orqali OTP tasdiqlash (Eskiz.uz integratsiyasi)
- ğŸ›‹ï¸ Mahsulotlar boshqaruvi (CRUD operatsiyalari)
- ğŸª Multi-shop arxitektura (bir foydalanuvchi bir nechta do'kon yaratishi mumkin)
- ğŸ“¦ Buyurtmalar boshqaruvi va real-time kuzatuv (WebSocket)
- ğŸ“Š Dashboard statistikasi va analytics
- ğŸ—‚ï¸ Kategoriyalar va hududlar boshqaruvi

---

## ğŸ› ï¸ Texnologik Stek

### Core Technologies:

- **Go 1.23.4** - Backend dasturlash tili
- **PostgreSQL** - Relational ma'lumotlar bazasi
- **JWT (golang-jwt/jwt/v5)** - Token-based autentifikatsiya
- **Gorilla WebSocket** - Real-time aloqa

### Asosiy Kutubxonalar:

- `github.com/lib/pq` - PostgreSQL driver
- `github.com/golang-jwt/jwt/v5` - JWT token yaratish va tekshirish
- `github.com/gorilla/websocket` - WebSocket server
- `golang.org/x/crypto` - Parol hashing (bcrypt)
- `github.com/google/uuid` - UUID generatsiya
- `github.com/joho/godotenv` - Environment variables boshqaruvi
- `github.com/swaggo/swag` - Swagger dokumentatsiya

### Xizmatlar:

- **Eskiz.uz SMS Gateway** - SMS yuborish xizmati
- **Swagger UI** - API dokumentatsiyasi (`/swagger/`)

---

## ğŸ“ Loyiha Strukturasi

Loyiha **Clean Architecture** prinsiplariga asoslangan:

```
mebellar-backend/
â”œâ”€â”€ handlers/          # HTTP request handlers (Controller layer)
â”‚   â”œâ”€â”€ auth.go       # Autentifikatsiya endpointlari
â”‚   â”œâ”€â”€ user.go       # Foydalanuvchi profili endpointlari
â”‚   â”œâ”€â”€ product.go    # Mahsulotlar endpointlari
â”‚   â”œâ”€â”€ category.go   # Kategoriyalar endpointlari
â”‚   â”œâ”€â”€ order.go      # Buyurtmalar endpointlari
â”‚   â”œâ”€â”€ seller_profile.go  # Sotuvchi profili va do'konlar
â”‚   â””â”€â”€ region.go     # Hududlar endpointlari
â”‚
â”œâ”€â”€ models/           # Data models (Domain layer)
â”‚   â”œâ”€â”€ user.go
â”‚   â”œâ”€â”€ product.go
â”‚   â”œâ”€â”€ category.go
â”‚   â”œâ”€â”€ order.go
â”‚   â”œâ”€â”€ seller_profile.go
â”‚   â””â”€â”€ region.go
â”‚
â”œâ”€â”€ pkg/              # Utility packages
â”‚   â”œâ”€â”€ config/       # Konfiguratsiya boshqaruvi
â”‚   â”œâ”€â”€ sms/          # SMS xizmati (Eskiz.uz)
â”‚   â”œâ”€â”€ websocket/    # WebSocket hub va handler
â”‚   â””â”€â”€ seed/         # Database seeder (kategoriyalar)
â”‚
â”œâ”€â”€ migrations/       # SQL migration fayllari
â”‚   â”œâ”€â”€ 002_create_seller_profiles.sql
â”‚   â”œâ”€â”€ 003_add_delivery_settings.sql
â”‚   â”œâ”€â”€ 004_add_shop_id_to_products.sql
â”‚   â”œâ”€â”€ 005_create_regions_table.sql
â”‚   â”œâ”€â”€ 006_add_product_analytics.sql
â”‚   â”œâ”€â”€ 007_create_orders_table.sql
â”‚   â”œâ”€â”€ 008_add_cancellation_reason.sql
â”‚   â””â”€â”€ 009_create_cancellation_reasons.sql
â”‚
â”œâ”€â”€ docs/            # Swagger dokumentatsiya (avtomatik generatsiya)
â”‚   â”œâ”€â”€ docs.go
â”‚   â”œâ”€â”€ swagger.json
â”‚   â””â”€â”€ swagger.yaml
â”‚
â”œâ”€â”€ uploads/         # Yuklangan fayllar (rasmlar)
â”œâ”€â”€ main.go          # Application entry point
â”œâ”€â”€ go.mod           # Go dependencies
â””â”€â”€ go.sum           # Dependency checksums
```

### Arxitektura Qatlamlari:

1. **Handlers Layer** - HTTP request/response boshqaruvi
2. **Models Layer** - Business logic va data strukturalari
3. **Pkg Layer** - Utility funksiyalar va xizmatlar
4. **Database Layer** - PostgreSQL ma'lumotlar bazasi

---

## ğŸ”Œ API Endpointlar

### Base URL

```
http://localhost:8081/api
```

### Autentifikatsiya (Auth)

| Method | Endpoint                | Vazifasi                              | Auth |
| ------ | ----------------------- | ------------------------------------- | ---- |
| POST   | `/auth/send-otp`        | OTP kod yuborish (telefon raqamiga)   | âŒ   |
| POST   | `/auth/verify-otp`      | OTP kodni tasdiqlash                  | âŒ   |
| POST   | `/auth/register`        | Yangi foydalanuvchi ro'yxatdan o'tish | âŒ   |
| POST   | `/auth/login`           | Tizimga kirish (telefon + parol)      | âŒ   |
| POST   | `/auth/forgot-password` | Parolni tiklash uchun OTP so'rash     | âŒ   |
| POST   | `/auth/reset-password`  | Parolni yangilash (OTP bilan)         | âŒ   |

### Foydalanuvchi Profili (User)

| Method | Endpoint                     | Vazifasi                                | Auth |
| ------ | ---------------------------- | --------------------------------------- | ---- |
| GET    | `/user/me`                   | Joriy foydalanuvchi profilini olish     | âœ…   |
| PUT    | `/user/me`                   | Profilni yangilash (ism, avatar)        | âœ…   |
| DELETE | `/user/me`                   | Hisobni o'chirish                       | âœ…   |
| POST   | `/user/change-phone/request` | Telefon o'zgartirish - OTP so'rash      | âœ…   |
| POST   | `/user/change-phone/verify`  | Telefon o'zgartirish - OTP tasdiqlash   | âœ…   |
| POST   | `/user/change-email/request` | Email o'zgartirish - OTP so'rash        | âœ…   |
| POST   | `/user/change-email/verify`  | Email o'zgartirish - OTP tasdiqlash     | âœ…   |
| POST   | `/user/become-seller`        | Sotuvchi bo'lish (seller roliga o'tish) | âœ…   |

### Kategoriyalar (Categories)

| Method | Endpoint                | Vazifasi                                | Auth |
| ------ | ----------------------- | --------------------------------------- | ---- |
| GET    | `/categories`           | Barcha kategoriyalar (daraxt struktura) | âŒ   |
| GET    | `/categories?flat=true` | Kategoriyalar tekis ro'yxatda           | âŒ   |
| GET    | `/categories/{id}`      | Bitta kategoriya ma'lumotlari           | âŒ   |

### Hududlar (Regions)

| Method | Endpoint   | Vazifasi                          | Auth |
| ------ | ---------- | --------------------------------- | ---- |
| GET    | `/regions` | Barcha faol hududlar (viloyatlar) | âŒ   |

### Mahsulotlar (Products) - Ommaviy

| Method | Endpoint                     | Vazifasi                    | Auth |
| ------ | ---------------------------- | --------------------------- | ---- |
| GET    | `/products`                  | Barcha mahsulotlar          | âŒ   |
| GET    | `/products?category_id={id}` | Kategoriya bo'yicha filter  | âŒ   |
| GET    | `/products/new`              | Yangi mahsulotlar           | âŒ   |
| GET    | `/products/popular`          | Mashhur mahsulotlar         | âŒ   |
| GET    | `/products/{id}`             | Bitta mahsulot ma'lumotlari | âŒ   |

### Sotuvchi Do'konlari (Seller Shops)

| Method | Endpoint             | Vazifasi                                | Auth | Headers |
| ------ | -------------------- | --------------------------------------- | ---- | ------- |
| GET    | `/seller/shops`      | Mening do'konlarim ro'yxati             | âœ…   | -       |
| POST   | `/seller/shops`      | Yangi do'kon yaratish                   | âœ…   | -       |
| GET    | `/seller/shops/{id}` | Do'kon ma'lumotlari                     | âœ…   | -       |
| PUT    | `/seller/shops/{id}` | Do'konni yangilash                      | âœ…   | -       |
| DELETE | `/seller/shops/{id}` | Do'konni o'chirish                      | âœ…   | -       |
| GET    | `/shops/{slug}`      | Ommaviy do'kon sahifasi (slug bo'yicha) | âŒ   | -       |

### Sotuvchi Mahsulotlari (Seller Products)

| Method | Endpoint                | Vazifasi                      | Auth | Headers     |
| ------ | ----------------------- | ----------------------------- | ---- | ----------- |
| GET    | `/seller/products`      | Mening mahsulotlarim ro'yxati | âœ…   | `X-Shop-ID` |
| POST   | `/seller/products`      | Yangi mahsulot yaratish       | âœ…   | `X-Shop-ID` |
| PUT    | `/seller/products/{id}` | Mahsulotni yangilash          | âœ…   | `X-Shop-ID` |
| DELETE | `/seller/products/{id}` | Mahsulotni o'chirish          | âœ…   | `X-Shop-ID` |

### Buyurtmalar (Orders)

#### Mijoz (Customer) - Ommaviy

| Method | Endpoint  | Vazifasi                | Auth |
| ------ | --------- | ----------------------- | ---- |
| POST   | `/orders` | Yangi buyurtma yaratish | âŒ   |

#### Sotuvchi (Seller)

| Method | Endpoint                                     | Vazifasi                        | Auth | Headers     |
| ------ | -------------------------------------------- | ------------------------------- | ---- | ----------- |
| GET    | `/seller/orders`                             | Buyurtmalar ro'yxati            | âœ…   | `X-Shop-ID` |
| GET    | `/seller/orders?status={status}`             | Status bo'yicha filter          | âœ…   | `X-Shop-ID` |
| GET    | `/seller/orders/stats`                       | Buyurtmalar statistikasi        | âœ…   | `X-Shop-ID` |
| PUT    | `/seller/orders/{id}/status?status={status}` | Buyurtma statusini o'zgartirish | âœ…   | `X-Shop-ID` |

**Buyurtma statuslari:** `new`, `confirmed`, `shipping`, `completed`, `cancelled`

### Sotuvchi Profili (Seller Profile)

| Method | Endpoint          | Vazifasi                              | Auth | Headers     |
| ------ | ----------------- | ------------------------------------- | ---- | ----------- |
| GET    | `/seller/profile` | Aggregated profil (user + shop stats) | âœ…   | `X-Shop-ID` |
| PUT    | `/seller/profile` | Profilni yangilash (ism, parol)       | âœ…   | `X-Shop-ID` |
| DELETE | `/seller/account` | Hisobni o'chirish (soft delete)       | âœ…   | -           |

### Dashboard va Analytics

| Method | Endpoint                          | Vazifasi               | Auth | Headers     |
| ------ | --------------------------------- | ---------------------- | ---- | ----------- |
| GET    | `/seller/dashboard/stats`         | Dashboard statistikasi | âœ…   | `X-Shop-ID` |
| GET    | `/seller/analytics/cancellations` | Bekor qilish tahlili   | âœ…   | `X-Shop-ID` |

### Umumiy (Common)

| Method | Endpoint                       | Vazifasi                        | Auth |
| ------ | ------------------------------ | ------------------------------- | ---- |
| GET    | `/common/cancellation-reasons` | Bekor qilish sabablari ro'yxati | âŒ   |

### Debug (Development)

| Method | Endpoint                       | Vazifasi                  | Auth |
| ------ | ------------------------------ | ------------------------- | ---- |
| POST   | `/debug/seed-orders?count={n}` | Test buyurtmalar yaratish | âœ…   |

### WebSocket (Real-time)

| Protocol | Endpoint                                | Vazifasi                      | Auth |
| -------- | --------------------------------------- | ----------------------------- | ---- |
| WS       | `/ws/orders?token={JWT}&shop_id={UUID}` | Real-time buyurtmalar kuzatuv | âœ…   |

### Static Files

| Method | Endpoint              | Vazifasi          |
| ------ | --------------------- | ----------------- |
| GET    | `/uploads/{filename}` | Yuklangan rasmlar |

### Swagger Dokumentatsiya

| Method | Endpoint              | Vazifasi   |
| ------ | --------------------- | ---------- |
| GET    | `/swagger/index.html` | Swagger UI |

---

## ğŸ” Autentifikatsiya

API JWT (JSON Web Token) orqali himoyalangan endpointlar uchun `Authorization` headerida token yuboriladi:

```
Authorization: Bearer {token}
```

Token 7 kun amal qiladi va quyidagi ma'lumotlarni o'z ichiga oladi:

- `user_id` - Foydalanuvchi ID
- `phone` - Telefon raqami
- `role` - Rol (customer, seller)
- `exp` - Amal qilish muddati

---

## âš™ï¸ O'rnatish va Ishga Tushirish

### Talablar:

- Go 1.24.0 yoki yuqori versiya
- PostgreSQL 12+
- `.env` fayl (konfiguratsiya)

### 1. Loyihani klonlash va dependencies o'rnatish

```bash
cd mebellar-backend
go mod download
```

### 2. Environment Variables sozlash

`.env` fayl yaratish:

```bash
cp .env.example .env
```

Kerakli qiymatlarni tahrirlash:

```env
# Database
DB_HOST=localhost
DB_PORT=5432
DB_USER=mebel_user
DB_PASSWORD=your_password
DB_NAME=mebellar_olami

# SSL Mode (production uchun REQUIRED!)
DB_SSLMODE=require

# Connection Pool
DB_MAX_OPEN_CONNS=25
DB_MAX_IDLE_CONNS=5
DB_CONN_MAX_LIFETIME=5m
DB_CONN_MAX_IDLE_TIME=5m

# Server
SERVER_PORT=8081
STATIC_PORT=8081
GRPC_PORT=50051

# JWT Secret (32+ characters required!)
# Generate: openssl rand -base64 32
JWT_SECRET=your-super-secret-jwt-key-minimum-32-chars

# SMS Service (Eskiz.uz)
ESKIZ_EMAIL=your@email.com
ESKIZ_PASSWORD=your_password

# Environment
ENVIRONMENT=development

# Logging
LOG_LEVEL=info
```

### ğŸ” Xavfsizlik (MUHIM!)

#### JWT Secret Generatsiyasi

**Production uchun MAJBURIY!** Kuchli tasodifiy secret yarating:

```bash
openssl rand -base64 32
```

Natijani `.env` fayliga qo'shing:

```env
JWT_SECRET=wOqJ3f7xM9kL2pN5tR8vY1zC4bH6jK0nQ3sU7wA9e=
```

**Qoidalar**:

- âœ… Minimum 32 ta belgi
- âŒ Default qiymatlarni ishlatmang
- âŒ Git'ga commit qilmang
- âœ… Har bir muhit uchun alohida secret

#### SSL/TLS Konfiguratsiyasi

**Production muhitida SSL MAJBURIY!**

```env
# Production
DB_SSLMODE=require

# Yoki sertifikat bilan
DB_SSLMODE=verify-full
DB_SSL_ROOT_CERT=/path/to/server-ca.pem
```

SSL rejimlari:

- `disable` - SSL o'chirilgan (faqat development)
- `require` - SSL majburiy
- `verify-ca` - Server sertifikatini tekshirish
- `verify-full` - Sertifikat + hostname tekshirish (tavsiya)

### 3. Database va Migrationlar

```bash
# PostgreSQL da database yaratish
createdb mebellar_olami

# Barcha migratsiyalarni avtomatik qo'llash
make migrate-up

# Migratsiya versiyasini ko'rish
make migrate-version

# Oxirgi migratsiyani bekor qilish
make migrate-down

# Yangi migratsiya yaratish
make migrate-create NAME=add_new_feature

# Bazani reset qilish (âš ï¸ barcha ma'lumotlar o'chadi!)
make db-reset
```

### 4. Serverni ishga tushirish

```bash
# Development mode
make run

# Yoki to'g'ridan-to'g'ri
go run main.go

# Build qilish
make build
./bin/mebellar-backend
```

**Server muvaffaqiyatli ishga tushganda**:

```
âœ… .env fayli yuklandi
2024-01-28T10:30:45+0500  INFO  Starting Mebellar Backend  {"environment": "development", "version": "1.0.0"}
2024-01-28T10:30:45+0500  INFO  Configuration validated successfully
2024-01-28T10:30:45+0500  INFO  Database connected successfully
2024-01-28T10:30:45+0500  INFO  Connection pool configured  {"max_open_connections": 25}
âœ… Ğ’ÑĞµ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ (Ñ‚ĞµĞºÑƒÑ‰Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ: 29)
2024-01-28T10:30:45+0500  INFO  Starting servers  {"static_port": "8081", "grpc_port": "50051"}
```

### ğŸ“ Structured Logging

Loyihada [zap](https://github.com/uber-go/zap) logger ishlatiladi.

**Log darajalari**:

```env
LOG_LEVEL=debug   # Batafsil ma'lumot (development)
LOG_LEVEL=info    # Standart (default)
LOG_LEVEL=warn    # Ogohlantirishlar
LOG_LEVEL=error   # Faqat xatoliklar
```

**Development** (rangli chiqish):

```
2024-01-28T10:30:45+0500  INFO  Starting server  {"port": "8081"}
```

**Production** (JSON format):

```json
{
  "level": "info",
  "timestamp": "2024-01-28T10:30:45Z",
  "msg": "Starting server",
  "port": "8081"
}
```

### ğŸ¥ Health Check va Monitoring

Server holatini tekshirish:

```bash
curl http://localhost:8081/health
```

Javob (connection pool statistikasi bilan):

```json
{
  "status": "ok",
  "service": "mebellar-backend",
  "database": {
    "open_connections": 5,
    "in_use": 2,
    "idle": 3,
    "wait_count": 0,
    "wait_duration_ms": 0,
    "max_idle_closed": 0,
    "max_lifetime_closed": 0
  }
}
```

### 5. Swagger dokumentatsiyasini generatsiya qilish

```bash
# Swagger CLI o'rnatish
go install github.com/swaggo/swag/cmd/swag@latest

# Dokumentatsiyani generatsiya qilish
swag init
```

---

## ğŸ§ª Testing

### API ni test qilish

1. **Swagger UI** orqali: `http://localhost:8081/swagger/index.html`
2. **Postman** yoki **cURL** orqali
3. **Flutter ilovalar** orqali integratsiya

### Test Endpointlar

```bash
# Health check
curl http://localhost:8081/api/categories

# OTP yuborish
curl -X POST http://localhost:8081/api/auth/send-otp \
  -H "Content-Type: application/json" \
  -d '{"phone": "+998901234567"}'
```

---

## ğŸ“Š Database Strukturasi

### Asosiy Jadvalar:

- `users` - Foydalanuvchilar
- `seller_profiles` - Sotuvchi profillari (Multi-Shop)
- `products` - Mahsulotlar
- `categories` - Kategoriyalar
- `orders` - Buyurtmalar
- `regions` - Hududlar (viloyatlar)
- `cancellation_reasons` - Bekor qilish sabablari

### Migrations:

Barcha migration fayllar `migrations/` papkasida joylashgan va ketma-ket bajarilishi kerak.

---

## ğŸ”§ Konfiguratsiya

Konfiguratsiya `.env` fayl orqali boshqariladi. Barcha sozlamalar `pkg/config/config.go` da yuklanadi.

### Muhim Sozlamalar:

- **JWT_SECRET** - Token imzolash uchun maxfiy kalit
- **ESKIZ_EMAIL/PASSWORD** - SMS xizmati uchun (agar bo'sh bo'lsa, mock rejimida ishlaydi)
- **DB\_\*** - Database ulanish parametrlari

---

## ğŸ“ API Response Format

Barcha API javoblari quyidagi formatda qaytadi:

```json
{
  "success": true,
  "message": "Muvaffaqiyatli",
  "data": { ... }
}
```

Xatolik holatida:

```json
{
  "success": false,
  "message": "Xatolik xabari"
}
```

---

## ğŸš€ Production Deployment

1. Environment variables ni production qiymatlariga o'zgartirish
2. `ENVIRONMENT=production` o'rnatish
3. Database backup yaratish
4. HTTPS sozlash (reverse proxy orqali: Nginx, Caddy)
5. Process manager ishlatish (systemd, PM2, Supervisord)

---

## ğŸ§ª Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

### Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ²ÑĞµÑ… Ñ‚ĞµÑÑ‚Ğ¾Ğ²

```bash
make test
```

### Unit Ñ‚ĞµÑÑ‚Ñ‹

```bash
make test-unit
```

### Integration Ñ‚ĞµÑÑ‚Ñ‹

```bash
make test-integration
```

### Coverage Ğ¾Ñ‚Ñ‡ĞµÑ‚

```bash
make test-coverage
```

### ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğ¹ Ğ‘Ğ”

```bash
make test-db-setup
```

### ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¾Ğ²

Ğ¤Ğ°Ğ¹Ğ» `.env.test`:

```env
TEST_DB_HOST=localhost
TEST_DB_PORT=5432
TEST_DB_USER=mebel_user
TEST_DB_PASSWORD=
TEST_DB_NAME=mebellar_test
```

---

## ğŸ“š Qo'shimcha Ma'lumotlar

- **Swagger UI**: `http://localhost:8081/swagger/index.html`
- **WebSocket**: Real-time buyurtmalar kuzatuv uchun
- **Multi-Shop**: Bir foydalanuvchi bir nechta do'kon yaratishi mumkin
- **File Uploads**: `uploads/` papkasida saqlanadi

---

## ğŸ‘¥ Mualliflar

Mebellar Olami Development Team

---

## ğŸ“„ License

Proprietary - All rights reserved
