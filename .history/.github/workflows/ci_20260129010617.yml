name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  GO_VERSION: "1.23"

jobs:
  lint:
    name: Lint & Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install dependencies
        run: go mod download

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          args: --timeout=5m

  build:
    name: Build & Verify
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install dependencies
        run: go mod download

      - name: Build binary
        run: |
          go build -v -o mebellar-backend-prod .
          echo "‚úÖ Build successful"

      - name: Verify binary
        run: |
          chmod +x mebellar-backend-prod
          ls -lh mebellar-backend-prod

  # Docker build (optional, for future container deployment)
  docker-build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: lint
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: mebellar-backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: [lint, build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            
            echo "üöÄ Starting deployment..."
            
            cd ~/mebellar-backend
            
            # Clean state
            git reset --hard origin/main
            git clean -fd
            
            # Pull latest code
            git pull origin main
            
            # Update dependencies
            /usr/local/go/bin/go mod tidy
            
            # Stop service
            sudo systemctl stop mebellar
            
            # Remove old binary
            rm -f mebellar-backend-prod
            
            # Build new binary
            /usr/local/go/bin/go build -o mebellar-backend-prod .
            chmod +x mebellar-backend-prod
            
            # Start service
            sudo systemctl start mebellar
            
            # Wait for startup
            echo "‚è≥ Waiting for backend to start..."
            sleep 10
            
            # Health check with retry
            for i in {1..5}; do
              if curl -f http://localhost:8081/health > /dev/null 2>&1; then
                echo "‚úÖ Deployment successful!"
                sudo systemctl status mebellar --no-pager -n 5
                exit 0
              fi
              echo "‚è≥ Retry $i/5..."
              sleep 3
            done
            
            # Deployment failed
            echo "‚ùå Deployment failed! Health check failed."
            sudo journalctl -u mebellar -n 50 --no-pager
            exit 1