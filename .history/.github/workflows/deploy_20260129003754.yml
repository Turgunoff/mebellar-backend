name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e

            echo "üöÄ Starting deployment..."

            cd ~/mebellar-backend
            git reset --hard origin/main
            git clean -fd
            git pull origin main

            /usr/local/go/bin/go mod tidy

            sudo systemctl stop mebellar
            rm -f mebellar-backend-prod

            /usr/local/go/bin/go build -o mebellar-backend-prod .
            chmod +x mebellar-backend-prod

            sudo systemctl start mebellar

            # Oshirildi: 5 ‚Üí 10 soniya
            echo "‚è≥ Waiting for backend to start..."
            sleep 10

            # Retry logic qo'shildi
            for i in {1..5}; do
              if curl -f http://localhost:8081/health > /dev/null 2>&1; then
                echo "‚úÖ Deployment successful!"
                sudo systemctl status mebellar --no-pager -n 5
                exit 0
              fi
              echo "‚è≥ Retry $i/5..."
              sleep 3
            done

            echo "‚ùå Deployment failed! Health check failed after 5 retries."
            sudo journalctl -u mebellar -n 50 --no-pager
            exit 1
